<!DOCTYPE html>
<html lang="zh-Hant-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pocket Random</title>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.15/lodash.min.js"></script>
    <!-- 引入样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">

</head>

<body>

    <button onclick="modify()">封存</button>
    <button onclick="retrieve()">取得文章</button>
    <div id="app">

    </div>
    <script src="app.bundle.js"></script>
    <!--
    <script>
        var Main = {
            data() {
            return {
                value: new Date()
            }
            }
        }
        var Ctor = Vue.extend(Main)
        new Ctor().$mount('#app')
      </script>
    -->


    <script>
        let ALL_ARTICLE = [];
        function retrieve() {
            fetch("https://localhost:3000/ajax/retrieve", {
                headers: {
                    "X-Requested-With": "XMLHttpRequest"
                }
            })
                .then(res => res.json())
                .then(res => {
                    app.textContent = res.data
                    ALL_ARTICLE = res.data
                })
        }
        function modify(actions) {
            fetch("https://localhost:3000/ajax/modify", {
                method: "post",
                headers: {
                    "Content-Type": "application/json; charset=UTF-8",
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: JSON.stringify({
                    abc: 132,
                    actions: actions
                })
            })
                .then(res => res.json())
                .then(data => {

                    console.log(data)
                })
        }


        function produceViewer(articles, setting) {
            return _.chain()
                .thru(() => getWeekday())
                .thru(weekday => getViewerSetByWeekday(setting, weekday).missions)
                .map(mission => {
                    const missionSet = setting.mission[mission.id];
                    const targetNum = mission.targetNum;
                    return {
                        ...mission,
                        name: missionSet.name,
                        accomplishNum: 0,
                        articles: getRandomArticles(articles, missionSet, targetNum)
                        // FIX : if no article match will return random article in all_article
                    }
                }).value()


        }

        function getRandomArticles(articles, missionSet, num) {
            return _.chain(articles)
                .filter(article => checkIfArticleMatch(article, missionSet))
                .shuffle()
                .slice(0, num)
                .value()
        }


        function checkIfArticleMatch(article, missionSet) {
            return _.chain(missionSet.protos)
                    .shuffle()        
                    .filter(filter => {
                        return _.intersection(article.tags, filter).length === filter.length;
                    })
                    .value().length > 0
        }

        function getViewerSetByWeekday(setting, weekday) {
            const weekdaySet = setting.viewer.weekday[weekday];
            return weekdaySet ? weekdaySet : setting.viewer.internal;
        }

        function getWeekday() {
            const weekday = new Date().getDay()
            return weekday != 0 ? weekday : 7;
        }


        const viewer = {
            accomplishNum_total: 0,
            targetNum_total: 5,
            missions: [
                {
                    missionId: "123456789",
                    name: "sample",
                    targetNum: 2,
                    accomplishNum: 0,
                    articles: []
                },
                {
                    missionId: "123456710",
                    name: "sample2",
                    targetNum: 3,
                    accomplishNum: 0,
                    articles: []
                }
            ]
        }
        const setting = {
            accomplishAction: "add_tag", // or "archive" or "both",
            accomplishTagName: "random_readed", // default, can modify by user
            mission: {
                "123456789": {
                    id: "sample",
                    name: "sample",
                    protos: [
                        ["動畫", "學校"],
                        ["工作"]
                    ],
                    status: "active"
                },
                "123456710": {
                    id: "123456789",
                    name: "sample2",
                    protos: [["未讀"]],
                    status: "deprecated"
                    // turn deprecated when press X button
                    // and never come back......
                }
            },
            viewer: {
                internal: { // internal for defualt , and can override by weekday
                    targetNum_total: 5,
                    missions: [
                        {
                            id: "123456789",
                            targetNum: 2
                        },
                        {
                            id: "123456710",
                            targetNum: 3
                        }
                    ]
                },
                weekday: {

                },

            }

        }

        const randomArticlesForRender = [
            {   // need get accomplished article & deprecated filter info from server
                // or it had to get it when get the page
                targetNumTotal: 5,
                articlesCollection: [
                    {
                        targetNum: 2,
                        accomplishNum: 0,
                        name: "missionName1",
                        articles: []// accomplishArticle with status : accomplish for render
                    },
                    {
                        targetNum: 3,
                        accomplishNum: 0,
                        name: "missionName2",
                        articles: [] // accomplishArticle with status : accomplish  for render

                    }
                ]
            }
        ]

        const sendToServerWhenArticleAccomplish = {
            missionId: 123,
            articleInfo: {},
            year: 2014,
            month: 12,
            date: 31,
            week: 52,
            time: "21:02"
            // or need split to year , month , .....
        }
        /*
        [mission] : all mission / all article / mission / article
        [某天] : 年、月、星期、天

        [某天]的 (mission) (article) 完成多少個？
        [某天]的 [mission] 達成率是多少？
        [某天]的 (mission) article 讀了什麼？

*/
        function shuffle(array) { // Fisher–Yates-shuffle
            var currentIndex = array.length, temporaryValue, randomIndex;

            // While there remain elements to shuffle...
            while (0 !== currentIndex) {

                // Pick a remaining element...
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex -= 1;

                // And swap it with the current element.
                temporaryValue = array[currentIndex];
                array[currentIndex] = array[randomIndex];
                array[randomIndex] = temporaryValue;
            }

            return array;
        }

        // Used like so


        // FIX : this can not solve all situation
        function makeRealfilters(setting) {
            var target = setting.filters;
            return _.map(target, filterSet => {
                var copyFilter = Object.assign({}, filterSet);
                var internal = _.intersection(...copyFilter.protos);

                copyFilter.real = _.chain(copyFilter.protos)
                    .map(proto => Array.from(proto))
                    .each((proto, i) => {
                        _.pullAll(proto, internal)
                    })
                    .unshift(internal)
                    .value()
                return copyFilter
            })
        }




        /*
        var result = _.map(target,filter =>{
            var newFilter = {
                ...filter
            }
            newFilter.internal = _.intersection(...newFilter.proto);

            newFilter.spec = _.map(newFilter.proto,itm => _.difference(itm, newFilter.internal))

            return newFilter
        })


        /*
            var internal = _.intersection(...target)
            var spec = _.map(target,itm => _.pull(itm,...internal))
        */
    </script>
</body>


</html>